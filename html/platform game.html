<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>platform game</title>
        <link rel="stylesheet" type="text/css"  href="./stylesheet.css">
        <style>
            #canvas {
                background-color: #123;
            }
            #Advanced {
                display: none;
            }
        </style>
    </head>
    <body onpointerup="pointerpressingistrue = false;" onkeydown="arrowKeyMove(event)">
        <h1>Title</h1>
        <ul class="menu">
            <li><a href="index.html">main</a></li>
            <li><a href="shooting game.html">game</a></li>
            <li><a href="mailto:no-reply@accounts.google.com">mail</a></li>
            <li><a href="https://en.wikipedia.org/wiki/Blog">blog</a></li>
            <li><a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">video</a></li>
        </ul>
        <div class="main">
            <h2>Platform Game</h2>
            <p>Make your own platform game.</p>
            <canvas id="canvas" width="400px" height="400px" onpointerdown="pointerPress(event)" onpointerup="pointerpressingistrue = false;" onpointermove="pointerxy[0] = event.x - c.offsetLeft; pointerxy[1] = event.y - c.offsetTop"></canvas>
            <br>
            <input type="button" class="button" onpointerdown="changeMode('playing')" value="play">
            <input type="button" class="button" onpointerdown="changeMode(1)" value="add platform">
            <input type="button" class="button" onpointerdown="changeMode(2)" value="add x">
            <input type="button" class="button" onpointerdown="changeMode(3)" value="add ?">
            <input type="button" class="button" onpointerdown="changeMode(4)" value="add water">
            <input type="button" class="button" onpointerdown="changeMode(0)" value="erase">
            <br>
            <br>
            <input type="button" class="button" onpointerdown="document.getElementById('Advanced').style.display = 'block'" value="Advanced">
            <div id="Advanced">
                <br>
                <input type="text" class="button" placeholder="start position ex.) 60, 340" id="sta rtPosition">
                <input type="button" class="button" onpointerdown="moveStartPos()" value="apply">
            </div>
            <p id="edit"> </p>
            <input type="button" class="button" onpointerdown="save()" value="save">
            <input type="text" class="button" onkeypress="load()" placeholder="load" id="load">
        </div>
        <script>
            var c = document.getElementById("canvas");
            var ctx = c.getContext("2d")
            var startPos = [60, 340]
            var player = {
                x: startPos[0],
                y: startPos[1],
                a: {x: 0, y: 0},
                v: {x: 0, y: 0},
            }
            var bounce = 0.5
            var friction = 1.05
            var frictionForce=[0,0]
            var dragForce=[0,0]
            var buoyancy = 0;
            var airDensity = .005
            var waterDensity = .5
            var gravity = 0.01
            var speed = 1
            var all = []
            for(var i = 0; i < 400; i++){
                all[i] = 0
            }
            all[58] = 1
            all[78] = 1
            all[98] = 1
            var editMode = false;
            var collisionDetector = [false, false, false, false]
            var pointerpressingistrue = false
            var pointerxy = [0, 0]
            var pressedKey = {}
            let status = [0, 0, 0, 0, 0];//[air, ground, x, wall, water]
            function platform(x, y, c, d) {
                var collision = x+20>=player.x+1 && x<=player.x+19 && y+20>=player.y+1 && y<=player.y+19
                if(d == 1){
                    ctx.fillStyle = "#246"
                }
                if(d == 2){
                    ctx.fillStyle = "#345"
                }
                if(d == 3){
                    ctx.fillStyle = "#444"
                    c[3] = false
                    c[1] = false
                    c[2] = false
                }
                if(d == 4){
                    ctx.fillStyle = "#147"
                    c = false
                }
                if(d == 0){
                    ctx.fillStyle = "#123"
                    c = false
                }
                ctx.fillRect(x, y, 20, 20)
                if(collision && d==0 && status[0] == 1){
                    status[0] = 1
                }
                if(x+20>=player.x+1 && x<=player.x+19 && player.y+20 >= y && d==1 && y+20>=player.y+1){
                    status[1] = 1
                }
                if(x+20>=player.x+1 && x<=player.x+19 && player.y+20 >= y && d==3 && y+20>=player.y+1 && c[4] != false){
                    status[1] = 1
                }
                if(collision && player.y <= y-15 && c[0] && ((c[4] != false && d==3) || d!=3)){
                    player.v.y = -bounce*Math.abs(player.v.y)
                    player.y -= 1
                    status[1] = 1
                }//up
                
                if(collision && d==4){
                    status[4] = 1
                }
                if(collision && player.y >= y+20-5 && c[1]){
                    player.v.y = bounce*Math.abs(player.v.y)
                    c[1] = false
                    player.y += 1
                }//down
                if(collision && player.x+15 <= x && c[2]){
                    player.x -= 1
                }//left
                if(collision && player.x >= x+20-5 && c[3]){
                    player.x += 1
                }//right
                if(collision && d == 2 && editMode == "playing"){
                    player = {
                        x: startPos[0],
                        y: startPos[1],
                        a: {x: 0, y: 0.01},
                        v: {x: 0, y: 0},
                    }
                    frictionForce=[0,0]
                    dragForce=[0,0]
                    buoyancy = 0;

                }
            }
            function inGame() {
                ctx.clearRect(0, 0, c.width, c.height)

                status = [1, 0, 0, 0, 0]
                for(var i = 0; i < 20; i++){
                    for(var j = 0; j < 20; j++){
                        collisionDetector = [true, true, true, true]
                        if(all[20*i+j+1] == 1 && j != 19){
                            collisionDetector[1] = false
                        }
                        if(all[20*i+j-1] == 3 && j != 0){
                            collisionDetector[4] = false
                        }
                        if(all[20*i+j-1] == 1 && j != 0){
                            collisionDetector[0] = false
                        }
                        if(all[20*i+j+20] == 1 && i != 19){
                            collisionDetector[3] = false
                        }
                        if(all[20*i+j-20] == 1 && i != 0){
                            collisionDetector[2] = false
                        }
                        if(all[20*i+j] >= 0){
                            platform(i*20, j*20, collisionDetector, all[20*i+j])
                        }
                    }
                }
                if(editMode == "playing"){
                    player.x += player.v.x;
                    player.v.x += player.a.x;
                    player.y += player.v.y;
                    player.v.y += player.a.y;
                    player.v.y += gravity
                    player.v.x += frictionForce[0];
                    player.v.y += frictionForce[1];
                    player.v.x += dragForce[0];
                    player.v.y += dragForce[1];
                    player.v.y += buoyancy
                }//move
                if(player.x<-20 || player.x>400 || player.y<-20 || player.y>400 || isNaN(player.y) || isNaN(player.x)) {
                    player = {
                        x: startPos[0],
                        y: startPos[1],
                        a: {x: 0, y: 0},
                        v: {x: 0, y: 0},
                    }
                }
                ctx.fillStyle = "#26A"
                ctx.fillRect(player.x, player.y, 20, 20)
                if(pointerpressingistrue){
                    for(var i = 0; i < 20; i++){
                        for(var j = 0; j < 20; j++){
                            if(Math.floor((pointerxy[0])/20) == i && Math.floor((pointerxy[1])/20) == j && typeof(editMode) == "number"){
                                all[20*i+j] = editMode
                            }
                        }   
                    }
                }
                if(status[0] == 1){
                    dragForce[0] = -(1/2)*airDensity*player.v.x*player.v.x*Math.sign(player.v.x)
                    dragForce[1] = -(1/2)*airDensity*player.v.y*player.v.y*Math.sign(player.v.y)
                    buoyancy = -airDensity*gravity
                    frictionForce[0] = 0
                    frictionForce[1] = 0
                }
                if(status[4] == 1){
                    dragForce[0] = -(1/2)*waterDensity*player.v.x*player.v.x*Math.sign(player.v.x)
                    dragForce[1] = -(1/2)*waterDensity*player.v.y*player.v.y*Math.sign(player.v.y)
                    buoyancy = -waterDensity*gravity
                    frictionForce[0] = 0
                    frictionForce[1] = 0
                }
                if(status[1] == 1){
                    frictionForce[0] = -gravity*friction*player.v.x
                    frictionForce[1] = -gravity*friction*player.v.y
                }
                document.getElementById("edit").innerHTML = status
            }
            function pointerPress(event) {
                if(editMode == "playing"){
                    player.v.x  = (event.x - c.offsetLeft - 10 - player.x)/100*speed
                    player.v.y  = (event.y - c.offsetTop - 10 - player.y)/100*speed
                }
                pointerpressingistrue = true
            }
            function changeMode(e) {
                editMode = e
                if(e == 1){
                    e = "editing(adding platform)"
                }
                if(e == 2){
                    e = "editing(adding x)"
                }
                if(e == 0){
                    e = "editing(erasing)"
                }
                if(e == 3){
                    e = "editing(adding ?)"
                }
                if(e == 4){
                    e = "editing(adding water)"
                }
                document.getElementById("edit").innerHTML = "now: " + e
            }
            function save() {
                navigator.clipboard.writeText(all + "," + startPos)
                alert("copied")
            }
            function load() {
                all = document.getElementById("load").value.split(",", 400)
                startPos[0] = Number(document.getElementById('load').value.split(',')[400]);
                startPos[1] = Number(document.getElementById('load').value.split(',')[401]);
            }
            function moveStartPos() {
                startPos[0] = Number(document.getElementById('startPosition').value.split(',')[0]);
                startPos[1] = Number(document.getElementById('startPosition').value.split(',')[1])
            }
            function arrowKeyMove(event) {
                if(editMode == "playing"){
                    pressedKey[event.key] = true;
                    
                    document.addEventListener('keyup', (event) => {
                        delete this.pressedKey[event.key];
                    });
                }
            }
            window.setInterval(inGame, 1)
            window.setInterval(function() {
                if(pressedKey.w && (status[1] == 1 || status[4] == 1)){
                    player.v.y = -1.4;
                    status[1] = 0
                }
                
                if(pressedKey.s && status[0] == 1){
                    player.a.y = 0.1;
                    player.v.x = 0
                }else{
                    player.a.y = 0
                }
                if(pressedKey.d){
                    if(player.v.x <= speed){
                        player.v.x += speed/50;
                    }
                }
                if(pressedKey.a){
                    if(player.v.x >= -speed){
                        player.v.x -= speed/50;
                    }
                }
            }, 1)
        </script>
    </body>
</html>